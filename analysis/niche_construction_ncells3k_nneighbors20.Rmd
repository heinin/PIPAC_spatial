---
title: "Niche analysis, N cells = 3k, N neighbors = 20"
author: "heinin"
date: "2025-06-18"
output:
  workflowr::wflow_html:
    code_folding: hide
  html_notebook: default
editor_options:
  chunk_output_type: console
---

### Load packages

```{r, warning=F, message=F}

suppressPackageStartupMessages({
  library(workflowr)
  library(arrow)
  library(Seurat)
  library(SeuratObject)
  library(SeuratDisk)
  library(tidyverse)
  library(tibble)
  library(ggplot2)
  library(ggpubr)
  library(ggrepel)
  library(googlesheets4)
  library(workflowr)
  library(patchwork)
  library(scProportionTest)})

```

### Environment variables and helper functions

```{r, message = F, warning = F}

setwd("/home/hnatri/PIPAC_spatial/")
set.seed(9999)
options(future.globals.maxSize = 30000 * 1024^2)
options(scipen = 99999)
options(ggrepel.max.overlaps = Inf)

source("/home/hnatri/PIPAC_spatial/code/PIPAC_colors_themes.R")
source("/home/hnatri/PIPAC_spatial/code/plot_functions.R")

# Lineage info
gs4_deauth()
metadata  <- gs4_get("https://docs.google.com/spreadsheets/d/1sXXwOreLxjMSUoPt79c6jmaQpluWkaxA5P5HfDsed3I/edit?usp=sharing")
lineage <- read_sheet(metadata, sheet = "Cell type annotations")

# Calling DEGs between two groups for each cell type
get_DEGs <- function(seuratdata, ctvar, celltypes, groupvar, group1, group2){
  #message(xx)
  DEGlist <- lapply(celltypes, function(xx){
    seuratdata$DEGgroup <- seuratdata@meta.data[,ctvar]
    data_subset <- subset(seuratdata, subset = DEGgroup == xx)
    Idents(data_subset) <- as.character(unlist(data_subset[[groupvar]]))
    
    if (min(table(unlist(data_subset[[groupvar]])))<20){
      return(NULL)
    }
    
    if (all((c(group1, group2) %in% unlist(data_subset[[groupvar]]) == c(T, T)))){
      markers <- FindMarkers(data_subset,
                             ident.1 = group1,
                             ident.2 = group2,
                             assay = "RNA",
                             verbose = F)
      markers$feature <- rownames(markers)
      markers[,ctvar] <- xx
      
      return(markers)
    } else {
      return(NULL)
    }
    })
  
  as.data.frame(do.call(rbind, DEGlist))
}

```

### Import data

```{r, message = F, warning = F, fig.width = 8, fig.height = 4}

seurat_data <- readRDS("/tgen_labs/banovich/PIPAC/Seurat/cell_merged_spatial_filtered_splitsamples_clustered_NC50_NN20_PC20_Seurat_denoIST_metadata_ncells3k_nk20_niches.rds")

```

### Niche construction

See /code/construct_niches.R

### Plotting niche composition

```{r, message = F, warning = F, fig.width = 6, fig.height = 4}

plot_list <- lapply(seq(3, 8), function(niche){
  niche_column <- paste0("ncells3k_niche_k", niche, "_n20")
  niches <- seq(1, niche)
  seurat_data@meta.data[,niche_column] <- factor(seurat_data@meta.data[,niche_column],
                                                 levels = niches)
  
  create_barplot(seurat_data,
                 group_var = niche_column,
                 plot_var = "Annotation",
                 group_levels = niches,
                 plot_levels = sort(unique(seurat_data$Annotation)),
                 plot_colors = pipac_celltype_col,
                 var_names =  c("Frequency (%)", ""),
                 legend_title = "Cell type")
  
})

plot_list

```

### Plotting by tissue

```{r, message = F, warning = F, fig.width = 4, fig.height = 4}

plot_list <- lapply(seq(3, 8), function(niche){
  niche_column <- paste0("ncells3k_niche_k", niche, "_n20")
  ct_table <- as.data.frame(table(seurat_data@meta.data[, niche_column], seurat_data$Tissue))
  colnames(ct_table) <- c("Niche", "Tissue", "Freq")
  ct_table <- spread(ct_table, Niche, Freq)
  # Converting to percetange
  #ct_table[,2:length(ct_table)] <- (ct_table[,2:length(ct_table)]/rowSums(ct_table[,2:length(ct_table)]))*100
  ct_table <- gather(ct_table, Niche, Freq, names(ct_table)[2:length(names(ct_table))], factor_key=TRUE)
      
  ct_table$Tissue <- factor(ct_table$Tissue, levels = c("Normal", "Tumor"))
  
  niches <- seq(1, niche)
  niches <- factor(niches, levels = niches)
  #niches <- sort(unique(seurat_data@meta.data[, niche_col]))
  niche_col <- colorRampPalette(brewer.pal(10, "Paired"))(nb.cols <- length(niches))
  names(niche_col) <- levels(niches)
  
  ggplot(ct_table, aes(x = Tissue, y = Freq, fill = Niche)) +
         geom_bar(stat="identity", position='stack', width = 0.8) +
         scale_fill_manual(name = "Niche", values = niche_col) +
         xlab("") +
         ylab("Cell count") +
         theme_classic() +
         theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
  
})

plot_list

```

### Plotting by sample

```{r, message = F, warning = F, fig.width = 12, fig.height = 4, eval = F}

plot_list <- lapply(seq(3, 8), function(niche){
  niche_column <- paste0("ncells3k_niche_k", niche, "_n20")
  niches <- seq(1, niche)
  seurat_data@meta.data[,niche_column] <- factor(seurat_data@meta.data[,niche_column],
                                                 levels = niches)
  niche_col <- colorRampPalette(brewer.pal(10, "Paired"))(nb.cols <- length(niches))
  names(niche_col) <- levels(niches)
  
  create_barplot(seurat_data,
                 plot_var = niche_column,
                 group_var = "Sample",
                 plot_levels = niches,
                 group_levels = sort(unique(seurat_data$Sample)),
                 plot_colors = niche_col,
                 var_names =  c("Frequency (%)", ""),
                 legend_title = "Niche")
  
})

plot_list

```

### Plotting by sample, Arm 3 tumors only

```{r, message = F, warning = F, fig.width = 10, fig.height = 4}

arm3_tumor <- subset(seurat_data, subset = Arm == "Arm3" &
                       Tissue == "Tumor")

plot_list <- lapply(seq(3, 8), function(niche){
  niche_column <- paste0("ncells3k_niche_k", niche, "_n20")
  niches <- seq(1, niche)
  arm3_tumor@meta.data[,niche_column] <- factor(arm3_tumor@meta.data[,niche_column],
                                                levels = niches)
  niche_col <- colorRampPalette(brewer.pal(10, "Paired"))(nb.cols <- length(niches))
  names(niche_col) <- levels(niches)
  
  create_barplot(arm3_tumor,
                 plot_var = niche_column,
                 group_var = "Sample",
                 plot_levels = niches,
                 group_levels = sort(unique(arm3_tumor$Sample)),
                 plot_colors = niche_col,
                 var_names =  c("Frequency (%)", ""),
                 legend_title = "Niche")
  
})

plot_list

```

### Plotting by sample, Arm 3 tumor adjacent only

```{r, message = F, warning = F, fig.width = 10, fig.height = 4}

arm3_normal <- subset(seurat_data, subset = Arm == "Arm3" &
                        Tissue == "Normal")

plot_list <- lapply(seq(3, 8), function(niche){
  niche_column <- paste0("ncells3k_niche_k", niche, "_n20")
  niches <- seq(1, niche)
  arm3_normal@meta.data[,niche_column] <- factor(arm3_normal@meta.data[,niche_column],
                                                 levels = niches)
  niche_col <- colorRampPalette(brewer.pal(10, "Paired"))(nb.cols <- length(niches))
  names(niche_col) <- levels(niches)
  
  create_barplot(arm3_normal,
                 plot_var = niche_column,
                 group_var = "Sample",
                 plot_levels = niches,
                 group_levels = sort(unique(arm3_normal$Sample)),
                 plot_colors = niche_col,
                 var_names =  c("Frequency (%)", ""),
                 legend_title = "Niche")
  
})

plot_list

```

### Spatial plots of niches

```{r, message = F, warning = F, fig.width = 8, fig.height = 5}

plot_list <- lapply(seq(3, 8), function(niche){
  
  niche_column <- paste0("ncells3k_niche_k", niche, "_n20")
  niches <- seq(1, niche)
  niches <- factor(niches, levels = niches)
  #niches <- sort(unique(seurat_data@meta.data[, niche_col]))
  niche_col <- colorRampPalette(brewer.pal(10, "Paired"))(nb.cols <- length(niches))
  names(niche_col) <- levels(niches)
  
  DimPlot(seurat_data,
          group.by = niche_column,
          cols = niche_col,
          reduction = "sp_adj") +
  coord_fixed()
  
})

plot_list

```

### Dotplot of cell assignment to niches by celltype

```{r, message = F, warning = F, fig.width = 5, fig.height = 8}

niche_ct_prop <- table(seurat_data$Annotation, seurat_data$ncells3k_niche_k5_n20)
niche_ct_prop <- prop.table(niche_ct_prop, margin = 2)
niche_ct_prop <- niche_ct_prop %>%
  as.data.frame()

# Adding lineage
niche_ct_prop$lineage <- mapvalues(niche_ct_prop$Var1,
                                   from = lineage$Annotation,
                                   to = lineage$Lineage)

niche_ct_prop$Var1 <- factor(niche_ct_prop$Var1,
                             levels = rev(unique(niche_ct_prop$Var1)))

p1 <- ggplot(niche_ct_prop, aes(x = Var2, y = Var1)) +
  geom_point(aes(size = Freq, 
                 #color = value,
                 fill = Var1), 
             stroke = 0.5,
             shape = 21) +
  guides(color = FALSE) +
  scale_fill_manual(values = pipac_celltype_col) +
  theme_bw() +
  xlab("") +
  ylab("") +
  facet_grid(lineage ~ ., scales = "free", space = "free")

# k6
niche_ct_prop <- table(seurat_data$Annotation, seurat_data$ncells3k_niche_k6_n20)
niche_ct_prop <- prop.table(niche_ct_prop, margin = 2)
niche_ct_prop <- niche_ct_prop %>%
  as.data.frame()

niche_ct_prop$lineage <- mapvalues(niche_ct_prop$Var1,
                                   from = lineage$Annotation,
                                   to = lineage$Lineage)

niche_ct_prop$Var1 <- factor(niche_ct_prop$Var1,
                             levels = rev(unique(niche_ct_prop$Var1)))

p2 <- ggplot(niche_ct_prop, aes(x = Var2, y = Var1)) +
  geom_point(aes(size = Freq, 
                 #color = value,
                 fill = Var1), 
             stroke = 0.5,
             shape = 21) +
  guides(color = FALSE) +
  scale_fill_manual(values = pipac_celltype_col) +
  theme_bw() +
  xlab("") +
  ylab("") +
  facet_grid(lineage ~ ., scales = "free", space = "free")

# k7
niche_ct_prop <- table(seurat_data$Annotation, seurat_data$ncells3k_niche_k7_n20)
niche_ct_prop <- prop.table(niche_ct_prop, margin = 2)
niche_ct_prop <- niche_ct_prop %>%
  as.data.frame()

niche_ct_prop$lineage <- mapvalues(niche_ct_prop$Var1,
                                   from = lineage$Annotation,
                                   to = lineage$Lineage)

niche_ct_prop$Var1 <- factor(niche_ct_prop$Var1,
                             levels = rev(unique(niche_ct_prop$Var1)))

p3 <- ggplot(niche_ct_prop, aes(x = Var2, y = Var1)) +
  geom_point(aes(size = Freq, 
                 #color = value,
                 fill = Var1), 
             stroke = 0.5,
             shape = 21) +
  guides(color = FALSE) +
  scale_fill_manual(values = pipac_celltype_col) +
  theme_bw() +
  xlab("") +
  ylab("") +
  facet_grid(lineage ~ ., scales = "free", space = "free")

p1

p2

p3

```

### Niche proportions by timepoint in Arm 3

```{r, message = F, warning = F, fig.width = 4, fig.height = 4}

arm3 <- subset(seurat_data, subset = Arm == "Arm3")

niches <- factor(seq(1, 5), levels = seq(1, 5))
niche_col <- colorRampPalette(brewer.pal(10, "Paired"))(nb.cols <- length(niches))
names(niche_col) <- as.character(niches)

create_barplot(arm3,
               plot_var = "ncells3k_niche_k5_n20",
               group_var = "Timepoint",
               plot_levels = niches,
               group_levels = c("0", "6"),
               plot_colors = niche_col,
               var_names =  c("Frequency (%)", ""),
               legend_title = "Niche") +
  ggtitle("Arm 3, all samples")

create_barplot(arm3_tumor,
               plot_var = "ncells3k_niche_k5_n20",
               group_var = "Timepoint",
               plot_levels = niches,
               group_levels = c("0", "6"),
               plot_colors = niche_col,
               var_names =  c("Frequency (%)", ""),
               legend_title = "Niche") +
  ggtitle("Arm 3, tumor")

create_barplot(arm3_normal,
               plot_var = "ncells3k_niche_k5_n20",
               group_var = "Timepoint",
               plot_levels = niches,
               group_levels = c("0", "6"),
               plot_colors = niche_col,
               var_names =  c("Frequency (%)", ""),
               legend_title = "Niche") +
  ggtitle("Arm 3, tumor-adjacent")

```

#### Testing for significance with scProportionTest

```{r, message = F, warning = F, fig.width = 5, fig.height = 4}

prop_test <- sc_utils(arm3)
prop_test <- permutation_test(
	prop_test, cluster_identity = "ncells3k_niche_k5_n20",
	sample_1 = "0", sample_2 = "6",
	sample_identity = "Timepoint")

permutation_plot(prop_test) +
  ggtitle("All Arm 3 samples")

prop_test <- sc_utils(arm3_tumor)
prop_test <- permutation_test(
	prop_test, cluster_identity = "ncells3k_niche_k5_n20",
	sample_1 = "0", sample_2 = "6",
	sample_identity = "Timepoint")

permutation_plot(prop_test) +
  ggtitle("Arm 3 tumors")

prop_test <- sc_utils(arm3_normal)
prop_test <- permutation_test(
	prop_test, cluster_identity = "ncells3k_niche_k5_n20",
	sample_1 = "0", sample_2 = "6",
	sample_identity = "Timepoint")

permutation_plot(prop_test) +
  ggtitle("Arm 3 tumor-adjacent")

```

### Niche proportions by timepoint in Arm 2

```{r, message = F, warning = F, fig.width = 4, fig.height = 4}

arm2 <- subset(seurat_data, subset = Arm == "Arm2")

arm2$pre_post <- ifelse(arm2$Timepoint == "0", "pre", "post")

arm2_tumor <- subset(arm2, subset = Tissue == "Tumor")

arm2_normal <- subset(arm2, subset = Tissue == "Normal")

niches <- factor(seq(1, 5), levels = seq(1, 5))
niche_col <- colorRampPalette(brewer.pal(10, "Paired"))(nb.cols <- length(niches))
names(niche_col) <- as.character(niches)

create_barplot(arm2,
               plot_var = "ncells3k_niche_k5_n20",
               group_var = "pre_post",
               plot_levels = niches,
               group_levels = c("pre", "post"),
               plot_colors = niche_col,
               var_names =  c("Frequency (%)", ""),
               legend_title = "Niche") +
  ggtitle("Arm 2, all samples")

create_barplot(arm2_tumor,
               plot_var = "ncells3k_niche_k5_n20",
               group_var = "pre_post",
               plot_levels = niches,
               group_levels = c("pre", "post"),
               plot_colors = niche_col,
               var_names =  c("Frequency (%)", ""),
               legend_title = "Niche") +
  ggtitle("Arm 2, tumor")

table(arm2_normal$pre_post, arm2_normal$ncells3k_niche_k5_n20)

create_barplot(arm2_normal,
               plot_var = "ncells3k_niche_k5_n20",
               group_var = "pre_post",
               plot_levels = niches,
               group_levels = c("pre", "post"),
               plot_colors = niche_col,
               var_names =  c("Frequency (%)", ""),
               legend_title = "Niche") +
  ggtitle("Arm 2, tumor-adjacent")

```

```{r, message = F, warning = F, fig.width = 5, fig.height = 4}

prop_test <- sc_utils(arm2)
prop_test <- permutation_test(
	prop_test, cluster_identity = "ncells3k_niche_k5_n20",
	sample_1 = "pre", sample_2 = "post",
	sample_identity = "pre_post")

permutation_plot(prop_test) +
  ggtitle("All Arm 2 samples")

prop_test <- sc_utils(arm2_tumor)
prop_test <- permutation_test(
	prop_test, cluster_identity = "ncells3k_niche_k5_n20",
	sample_1 = "pre", sample_2 = "post",
	sample_identity = "pre_post")

permutation_plot(prop_test) +
  ggtitle("Arm 2 tumors")

prop_test <- sc_utils(arm2_normal)
prop_test <- permutation_test(
	prop_test, cluster_identity = "ncells3k_niche_k5_n20",
	sample_1 = "pre", sample_2 = "post",
	sample_identity = "pre_post")

permutation_plot(prop_test) +
  ggtitle("Arm 2 tumor-adjacent")

# To build on command line, run Rscript -e "rmarkdown::render('niche_construction_ncells3k_nneighbors20.Rmd')"
# Then "mv *.html /home/hnatri/PIPAC_spatial/docs/"

```
